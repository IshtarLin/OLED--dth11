C51 COMPILER V9.54   IIC                                                                   09/19/2024 08:15:27 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE IIC
OBJECT MODULE PLACED IN .\Objects\IIC.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE IIC.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\IIC.l
                    -st) OBJECT(.\Objects\IIC.obj)

line level    source

   1          #include        "I2C.h"
*** WARNING C318 IN LINE 1 OF IIC.c: can't open file 'I2C.h'
   2          
   3          u8 xdata I2C_Buffer[I2C_BUF_LENTH];
*** ERROR C129 IN LINE 3 OF IIC.c: missing ';' before 'xdata'
   4          
   5          //========================================================================
   6          // å‡½æ•°: void I2C_Init(I2C_InitTypeDef *I2Cx)
   7          // æè¿°: I2Cåˆå§‹åŒ–ç¨‹åº.
   8          // å‚æ•°: I2Cx: ç»“æ„å‚æ•°,è¯·å‚è€ƒI2C.hé‡Œçš„å®šä¹‰.
   9          // è¿”å›: none.
  10          // ç‰ˆæœ¬: V1.0, 2012-11-22
  11          //========================================================================
  12          void I2C_Init(I2C_InitTypeDef *I2Cx)
  13          {
  14                  if(I2Cx->I2C_Mode == I2C_Mode_Master)
  15                  {
  16                          I2C_Master();                   //è®¾ä¸ºä¸»æœº  
  17                          I2CMSST = 0x00;         //æ¸…é™¤I2Cä¸»æœºçŠ¶æ€å¯„å­˜å™¨
  18                          I2C_SetSpeed(I2Cx->I2C_Speed);
  19                          if(I2Cx->I2C_MS_WDTA == ENABLE)         I2C_WDTA_EN();  //ä½¿èƒ½è‡ªåŠ¨å‘é€
  20                          else                                                                    I2C_WDTA_DIS(); //ç¦æ­¢è‡ªåŠ¨å‘é€
  21                  }
  22                  else
  23                  {
  24                          I2C_Slave();    //è®¾ä¸ºä»æœº
  25                          I2CSLST = 0x00;         //æ¸…é™¤I2Cä»æœºçŠ¶æ€å¯„å­˜å™¨
  26                          I2C_Address(I2Cx->I2C_SL_ADR);
  27                          if(I2Cx->I2C_SL_MA == ENABLE)           I2C_MATCH_EN(); //ä»æœºåœ°å€æ¯”è¾ƒåŠŸèƒ½ï¼Œåªæ¥å—ç›¸åŒ¹é…åœ°å€
  28                          else                                                                    I2C_MATCH_DIS();        //ç¦æ­¢ä»æœºåœ°å€æ¯”è¾ƒåŠŸèƒ½ï¼Œæ¥å—æ‰€æœ‰è®¾å¤‡åœ°å€
  29                  }
  30                  
  31                  I2C_Function(I2Cx->I2C_Enable);
  32          }
  33          
  34          //========================================================================
  35          // å‡½æ•°: u8   Get_MSBusy_Status (void)
  36          // æè¿°: è·å–ä¸»æœºå¿™ç¢ŒçŠ¶æ€.
  37          // å‚æ•°: none.
  38          // è¿”å›: ä¸»æœºå¿™ç¢ŒçŠ¶æ€.
  39          // ç‰ˆæœ¬: V1.0, 2012-11-22
  40          //========================================================================
  41          u8 Get_MSBusy_Status(void)
  42          {
  43                  return (I2CMSST & 0x80);
  44          }
  45          
  46          //========================================================================
  47          // å‡½æ•°: void Wait (void)
  48          // æè¿°: ç­‰å¾…ä¸»æœºæ¨¡å¼I2Cæ§åˆ¶å™¨æ‰§è¡Œå®ŒæˆI2CMSCR.
  49          // å‚æ•°: none.
  50          // è¿”å›: none.
  51          // ç‰ˆæœ¬: V1.0, 2012-11-22
  52          //========================================================================
C51 COMPILER V9.54   IIC                                                                   09/19/2024 08:15:27 PAGE 2   

  53          void Wait()
  54          {
  55                  while (!(I2CMSST & 0x40));
  56                  I2CMSST &= ~0x40;
  57          }
  58          
  59          //========================================================================
  60          // å‡½æ•°: void Start (void)
  61          // æè¿°: I2Cæ€»çº¿èµ·å§‹å‡½æ•°.
  62          // å‚æ•°: none.
  63          // è¿”å›: none.
  64          // ç‰ˆæœ¬: V1.0, 2020-09-15
  65          //========================================================================
  66          void Start()
  67          {
  68                  I2CMSCR = 0x01;                         //å‘é€STARTå‘½ä»¤
  69                  Wait();
  70          }
  71          
  72          //========================================================================
  73          // å‡½æ•°: void SendData (char dat)
  74          // æè¿°: I2Cå‘é€ä¸€ä¸ªå­—èŠ‚æ•°æ®å‡½æ•°.
  75          // å‚æ•°: å‘é€çš„æ•°æ®.
  76          // è¿”å›: none.
  77          // ç‰ˆæœ¬: V1.0, 2020-09-15
  78          //========================================================================
  79          void SendData(char dat)
  80          {
  81                  I2CTXD = dat;                           //å†™æ•°æ®åˆ°æ•°æ®ç¼“å†²åŒº
  82                  I2CMSCR = 0x02;                         //å‘é€SENDå‘½ä»¤
  83                  Wait();
  84          }
  85          
  86          //========================================================================
  87          // å‡½æ•°: void RecvACK (void)
  88          // æè¿°: I2Cè·å–ACKå‡½æ•°.
  89          // å‚æ•°: none.
  90          // è¿”å›: none.
  91          // ç‰ˆæœ¬: V1.0, 2020-09-15
  92          //========================================================================
  93          void RecvACK()
  94          {
  95                  I2CMSCR = 0x03;                         //å‘é€è¯»ACKå‘½ä»¤
  96                  Wait();
  97          }
  98          
  99          //========================================================================
 100          // å‡½æ•°: char RecvData (void)
 101          // æè¿°: I2Cè¯»å–ä¸€ä¸ªå­—èŠ‚æ•°æ®å‡½æ•°.
 102          // å‚æ•°: none.
 103          // è¿”å›: è¯»å–æ•°æ®.
 104          // ç‰ˆæœ¬: V1.0, 2020-09-15
 105          //========================================================================
 106          char RecvData()
 107          {
 108                  I2CMSCR = 0x04;                         //å‘é€RECVå‘½ä»¤
 109                  Wait();
 110                  return I2CRXD;
 111          }
 112          
 113          //========================================================================
 114          // å‡½æ•°: void SendACK (void)
C51 COMPILER V9.54   IIC                                                                   09/19/2024 08:15:27 PAGE 3   

 115          // æè¿°: I2Cå‘é€ACKå‡½æ•°.
 116          // å‚æ•°: none.
 117          // è¿”å›: none.
 118          // ç‰ˆæœ¬: V1.0, 2020-09-15
 119          //========================================================================
 120          void SendACK()
 121          {
 122                  I2CMSST = 0x00;                         //è®¾ç½®ACKä¿¡å·
 123                  I2CMSCR = 0x05;                         //å‘é€ACKå‘½ä»¤
 124                  Wait();
 125          }
 126          
 127          //========================================================================
 128          // å‡½æ•°: void SendNAK (void)
 129          // æè¿°: I2Cå‘é€NAKå‡½æ•°.
 130          // å‚æ•°: none.
 131          // è¿”å›: none.
 132          // ç‰ˆæœ¬: V1.0, 2020-09-15
 133          //========================================================================
 134          void SendNAK()
 135          {
 136                  I2CMSST = 0x01;                         //è®¾ç½®NAKä¿¡å·
 137                  I2CMSCR = 0x05;                         //å‘é€ACKå‘½ä»¤
 138                  Wait();
 139          }
 140          
 141          //========================================================================
 142          // å‡½æ•°: void Stop (void)
 143          // æè¿°: I2Cæ€»çº¿åœæ­¢å‡½æ•°.
 144          // å‚æ•°: none.
 145          // è¿”å›: none.
 146          // ç‰ˆæœ¬: V1.0, 2020-09-15
 147          //========================================================================
 148          void Stop()
 149          {
 150                  I2CMSCR = 0x06;                         //å‘é€STOPå‘½ä»¤
 151                  Wait();
 152          }
 153          
 154          //========================================================================
 155          // å‡½æ•°: void SendCmdData (u8 cmd, u8 dat)
 156          // æè¿°: I2Cå‘é€ä¸€ä¸ªå­—èŠ‚æ•°æ®å‡½æ•°.
 157          // å‚æ•°: å‘½ä»¤/æ•°æ®.
 158          // è¿”å›: none.
 159          // ç‰ˆæœ¬: V1.0, 2020-09-15
 160          //========================================================================
 161          void SendCmdData(u8 cmd, u8 dat)
 162          {
 163                  I2CTXD = dat;                           //å†™æ•°æ®åˆ°æ•°æ®ç¼“å†²åŒº
 164                  I2CMSCR = cmd;                          //è®¾ç½®å‘½ä»¤
 165                  Wait();
 166          }
 167          
 168          //========================================================================
 169          // å‡½æ•°: void I2C_WriteNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)
 170          // æè¿°: I2Cå†™å…¥æ•°æ®å‡½æ•°.
 171          // å‚æ•°: dev_addr: è®¾å¤‡åœ°å€, mem_addr: å­˜å‚¨åœ°å€, *på†™å…¥æ•°æ®å­˜å‚¨ä½ç½®, numberå†™å…¥æ•°æ®ä
             -¸ªæ•°.
 172          // è¿”å›: none.
 173          // ç‰ˆæœ¬: V1.0, 2020-09-15
 174          //========================================================================
 175          void I2C_WriteNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)  /*  DeviceAddress,WordAddress,First Data 
C51 COMPILER V9.54   IIC                                                                   09/19/2024 08:15:27 PAGE 4   

             -Address,Byte lenth   */
 176          {
 177                  Start();                                //å‘é€èµ·å§‹å‘½ä»¤
 178                  SendData(dev_addr);                     //å‘é€è®¾å¤‡åœ°å€+å†™å‘½ä»¤
 179                  RecvACK();
 180                  SendData(mem_addr);                     //å‘é€å­˜å‚¨åœ°å€
 181                  RecvACK();
 182                  do
 183                  {
 184                          SendData(*p++);
 185                          RecvACK();
 186                  }
 187                  while(--number);
 188                  Stop();                                 //å‘é€åœæ­¢å‘½ä»¤
 189          }
 190          
 191          //========================================================================
 192          // å‡½æ•°: void I2C_ReadNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)
 193          // æè¿°: I2Cè¯»å–æ•°æ®å‡½æ•°.
 194          // å‚æ•°: dev_addr: è®¾å¤‡åœ°å€, mem_addr: å­˜å‚¨åœ°å€, *pè¯»å–æ•°æ®å­˜å‚¨ä½ç½®, numberè¯»å–æ•°æ®ä
             -¸ªæ•°.
 195          // è¿”å›: none.
 196          // ç‰ˆæœ¬: V1.0, 2020-09-15
 197          //========================================================================
 198          void I2C_ReadNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)   /*  DeviceAddress,WordAddress,First Data 
             -Address,Byte lenth   */
 199          {
 200                  Start();                                //å‘é€èµ·å§‹å‘½ä»¤
 201                  SendData(dev_addr);                     //å‘é€è®¾å¤‡åœ°å€+å†™å‘½ä»¤
 202                  RecvACK();
 203                  SendData(mem_addr);                     //å‘é€å­˜å‚¨åœ°å€
 204                  RecvACK();
 205                  Start();                                //å‘é€èµ·å§‹å‘½ä»¤
 206                  SendData(dev_addr|1);                   //å‘é€è®¾å¤‡åœ°å€+è¯»å‘½ä»¤
 207                  RecvACK();
 208                  do
 209                  {
 210                          *p = RecvData();
 211                          p++;
 212                          if(number != 1) SendACK();          //send ACK
 213                  }
 214                  while(--number);
 215                  SendNAK();                              //send no ACK   
 216                  Stop();                                 //å‘é€åœæ­¢å‘½ä»¤
 217          }

C51 COMPILATION COMPLETE.  1 WARNING(S),  1 ERROR(S)
