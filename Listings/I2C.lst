C51 COMPILER V9.54   I2C                                                                   09/19/2024 08:16:20 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE I2C
OBJECT MODULE PLACED IN .\Objects\I2C.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE I2C.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\I2C.l
                    -st) OBJECT(.\Objects\I2C.obj)

line level    source

   1          #include        "I2C.h"
   2          
   3          u8 xdata I2C_Buffer[I2C_BUF_LENTH];
   4          
   5          //========================================================================
   6          // å‡½æ•°: void I2C_Init(I2C_InitTypeDef *I2Cx)
   7          // æè¿°: I2Cåˆå§‹åŒ–ç¨‹åº.
   8          // å‚æ•°: I2Cx: ç»“æ„å‚æ•°,è¯·å‚è€ƒI2C.hé‡Œçš„å®šä¹‰.
   9          // è¿”å›: none.
  10          // ç‰ˆæœ¬: V1.0, 2012-11-22
  11          //========================================================================
  12          void I2C_Init(I2C_InitTypeDef *I2Cx)
  13          {
  14   1              if(I2Cx->I2C_Mode == I2C_Mode_Master)
  15   1              {
  16   2                      I2C_Master();                   //è®¾ä¸ºä¸»æœº  
  17   2                      I2CMSST = 0x00;         //æ¸…é™¤I2Cä¸»æœºçŠ¶æ€å¯„å­˜å™¨
  18   2                      I2C_SetSpeed(I2Cx->I2C_Speed);
  19   2                      if(I2Cx->I2C_MS_WDTA == ENABLE)         I2C_WDTA_EN();  //ä½¿èƒ½è‡ªåŠ¨å‘é€
  20   2                      else                                                                    I2C_WDTA_DIS(); //ç¦æ­¢è‡ªåŠ¨å‘é€
  21   2              }
  22   1              else
  23   1              {
  24   2                      I2C_Slave();    //è®¾ä¸ºä»æœº
  25   2                      I2CSLST = 0x00;         //æ¸…é™¤I2Cä»æœºçŠ¶æ€å¯„å­˜å™¨
  26   2                      I2C_Address(I2Cx->I2C_SL_ADR);
  27   2                      if(I2Cx->I2C_SL_MA == ENABLE)           I2C_MATCH_EN(); //ä»æœºåœ°å€æ¯”è¾ƒåŠŸèƒ½ï¼Œåªæ¥å—ç›¸åŒ¹é…åœ°å€
  28   2                      else                                                                    I2C_MATCH_DIS();        //ç¦æ­¢ä»æœºåœ°å€æ¯”è¾ƒåŠŸèƒ½ï¼Œæ¥å—æ‰€æœ‰è®¾å¤‡åœ°å€
  29   2              }
  30   1              
  31   1              I2C_Function(I2Cx->I2C_Enable);
  32   1      }
  33          
  34          //========================================================================
  35          // å‡½æ•°: u8   Get_MSBusy_Status (void)
  36          // æè¿°: è·å–ä¸»æœºå¿™ç¢ŒçŠ¶æ€.
  37          // å‚æ•°: none.
  38          // è¿”å›: ä¸»æœºå¿™ç¢ŒçŠ¶æ€.
  39          // ç‰ˆæœ¬: V1.0, 2012-11-22
  40          //========================================================================
  41          u8 Get_MSBusy_Status(void)
  42          {
  43   1              return (I2CMSST & 0x80);
  44   1      }
  45          
  46          //========================================================================
  47          // å‡½æ•°: void Wait (void)
  48          // æè¿°: ç­‰å¾…ä¸»æœºæ¨¡å¼I2Cæ§åˆ¶å™¨æ‰§è¡Œå®ŒæˆI2CMSCR.
  49          // å‚æ•°: none.
  50          // è¿”å›: none.
  51          // ç‰ˆæœ¬: V1.0, 2012-11-22
  52          //========================================================================
  53          void Wait()
  54          {
C51 COMPILER V9.54   I2C                                                                   09/19/2024 08:16:20 PAGE 2   

  55   1              while (!(I2CMSST & 0x40));
  56   1              I2CMSST &= ~0x40;
  57   1      }
  58          
  59          //========================================================================
  60          // å‡½æ•°: void Start (void)
  61          // æè¿°: I2Cæ€»çº¿èµ·å§‹å‡½æ•°.
  62          // å‚æ•°: none.
  63          // è¿”å›: none.
  64          // ç‰ˆæœ¬: V1.0, 2020-09-15
  65          //========================================================================
  66          void Start()
  67          {
  68   1              I2CMSCR = 0x01;                         //å‘é€STARTå‘½ä»¤
  69   1              Wait();
  70   1      }
  71          
  72          //========================================================================
  73          // å‡½æ•°: void SendData (char dat)
  74          // æè¿°: I2Cå‘é€ä¸€ä¸ªå­—èŠ‚æ•°æ®å‡½æ•°.
  75          // å‚æ•°: å‘é€çš„æ•°æ®.
  76          // è¿”å›: none.
  77          // ç‰ˆæœ¬: V1.0, 2020-09-15
  78          //========================================================================
  79          void SendData(char dat)
  80          {
  81   1              I2CTXD = dat;                           //å†™æ•°æ®åˆ°æ•°æ®ç¼“å†²åŒº
  82   1              I2CMSCR = 0x02;                         //å‘é€SENDå‘½ä»¤
  83   1              Wait();
  84   1      }
  85          
  86          //========================================================================
  87          // å‡½æ•°: void RecvACK (void)
  88          // æè¿°: I2Cè·å–ACKå‡½æ•°.
  89          // å‚æ•°: none.
  90          // è¿”å›: none.
  91          // ç‰ˆæœ¬: V1.0, 2020-09-15
  92          //========================================================================
  93          void RecvACK()
  94          {
  95   1              I2CMSCR = 0x03;                         //å‘é€è¯»ACKå‘½ä»¤
  96   1              Wait();
  97   1      }
  98          
  99          //========================================================================
 100          // å‡½æ•°: char RecvData (void)
 101          // æè¿°: I2Cè¯»å–ä¸€ä¸ªå­—èŠ‚æ•°æ®å‡½æ•°.
 102          // å‚æ•°: none.
 103          // è¿”å›: è¯»å–æ•°æ®.
 104          // ç‰ˆæœ¬: V1.0, 2020-09-15
 105          //========================================================================
 106          char RecvData()
 107          {
 108   1              I2CMSCR = 0x04;                         //å‘é€RECVå‘½ä»¤
 109   1              Wait();
 110   1              return I2CRXD;
 111   1      }
 112          
 113          //========================================================================
 114          // å‡½æ•°: void SendACK (void)
 115          // æè¿°: I2Cå‘é€ACKå‡½æ•°.
 116          // å‚æ•°: none.
C51 COMPILER V9.54   I2C                                                                   09/19/2024 08:16:20 PAGE 3   

 117          // è¿”å›: none.
 118          // ç‰ˆæœ¬: V1.0, 2020-09-15
 119          //========================================================================
 120          void SendACK()
 121          {
 122   1              I2CMSST = 0x00;                         //è®¾ç½®ACKä¿¡å·
 123   1              I2CMSCR = 0x05;                         //å‘é€ACKå‘½ä»¤
 124   1              Wait();
 125   1      }
 126          
 127          //========================================================================
 128          // å‡½æ•°: void SendNAK (void)
 129          // æè¿°: I2Cå‘é€NAKå‡½æ•°.
 130          // å‚æ•°: none.
 131          // è¿”å›: none.
 132          // ç‰ˆæœ¬: V1.0, 2020-09-15
 133          //========================================================================
 134          void SendNAK()
 135          {
 136   1              I2CMSST = 0x01;                         //è®¾ç½®NAKä¿¡å·
 137   1              I2CMSCR = 0x05;                         //å‘é€ACKå‘½ä»¤
 138   1              Wait();
 139   1      }
 140          
 141          //========================================================================
 142          // å‡½æ•°: void Stop (void)
 143          // æè¿°: I2Cæ€»çº¿åœæ­¢å‡½æ•°.
 144          // å‚æ•°: none.
 145          // è¿”å›: none.
 146          // ç‰ˆæœ¬: V1.0, 2020-09-15
 147          //========================================================================
 148          void Stop()
 149          {
 150   1              I2CMSCR = 0x06;                         //å‘é€STOPå‘½ä»¤
 151   1              Wait();
 152   1      }
 153          
 154          //========================================================================
 155          // å‡½æ•°: void SendCmdData (u8 cmd, u8 dat)
 156          // æè¿°: I2Cå‘é€ä¸€ä¸ªå­—èŠ‚æ•°æ®å‡½æ•°.
 157          // å‚æ•°: å‘½ä»¤/æ•°æ®.
 158          // è¿”å›: none.
 159          // ç‰ˆæœ¬: V1.0, 2020-09-15
 160          //========================================================================
 161          void SendCmdData(u8 cmd, u8 dat)
 162          {
 163   1              I2CTXD = dat;                           //å†™æ•°æ®åˆ°æ•°æ®ç¼“å†²åŒº
 164   1              I2CMSCR = cmd;                          //è®¾ç½®å‘½ä»¤
 165   1              Wait();
 166   1      }
 167          
 168          //========================================================================
 169          // å‡½æ•°: void I2C_WriteNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)
 170          // æè¿°: I2Cå†™å…¥æ•°æ®å‡½æ•°.
 171          // å‚æ•°: dev_addr: è®¾å¤‡åœ°å€, mem_addr: å­˜å‚¨åœ°å€, *på†™å…¥æ•°æ®å­˜å‚¨ä½ç½®, numberå†™å…¥æ•°æ®ä
             -¸ªæ•°.
 172          // è¿”å›: none.
 173          // ç‰ˆæœ¬: V1.0, 2020-09-15
 174          //========================================================================
 175          void I2C_WriteNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)  /*  DeviceAddress,WordAddress,First Data 
             -Address,Byte lenth   */
 176          {
C51 COMPILER V9.54   I2C                                                                   09/19/2024 08:16:20 PAGE 4   

 177   1              Start();                                //å‘é€èµ·å§‹å‘½ä»¤
 178   1              SendData(dev_addr);                     //å‘é€è®¾å¤‡åœ°å€+å†™å‘½ä»¤
 179   1              RecvACK();
 180   1              SendData(mem_addr);                     //å‘é€å­˜å‚¨åœ°å€
 181   1              RecvACK();
 182   1              do
 183   1              {
 184   2                      SendData(*p++);
 185   2                      RecvACK();
 186   2              }
 187   1              while(--number);
 188   1              Stop();                                 //å‘é€åœæ­¢å‘½ä»¤
 189   1      }
 190          
 191          //========================================================================
 192          // å‡½æ•°: void I2C_ReadNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)
 193          // æè¿°: I2Cè¯»å–æ•°æ®å‡½æ•°.
 194          // å‚æ•°: dev_addr: è®¾å¤‡åœ°å€, mem_addr: å­˜å‚¨åœ°å€, *pè¯»å–æ•°æ®å­˜å‚¨ä½ç½®, numberè¯»å–æ•°æ®ä
             -¸ªæ•°.
 195          // è¿”å›: none.
 196          // ç‰ˆæœ¬: V1.0, 2020-09-15
 197          //========================================================================
 198          void I2C_ReadNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)   /*  DeviceAddress,WordAddress,First Data 
             -Address,Byte lenth   */
 199          {
 200   1              Start();                                //å‘é€èµ·å§‹å‘½ä»¤
 201   1              SendData(dev_addr);                     //å‘é€è®¾å¤‡åœ°å€+å†™å‘½ä»¤
 202   1              RecvACK();
 203   1              SendData(mem_addr);                     //å‘é€å­˜å‚¨åœ°å€
 204   1              RecvACK();
 205   1              Start();                                //å‘é€èµ·å§‹å‘½ä»¤
 206   1              SendData(dev_addr|1);                   //å‘é€è®¾å¤‡åœ°å€+è¯»å‘½ä»¤
 207   1              RecvACK();
 208   1              do
 209   1              {
 210   2                      *p = RecvData();
 211   2                      p++;
 212   2                      if(number != 1) SendACK();          //send ACK
 213   2              }
 214   1              while(--number);
 215   1              SendNAK();                              //send no ACK   
 216   1              Stop();                                 //å‘é€åœæ­¢å‘½ä»¤
 217   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    358    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =      8    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      12
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
